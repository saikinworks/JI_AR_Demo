<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MindAR Transparent Video (Mask Shader Synced iOS Friendly)</title>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }
      a-scene {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
    </style>

    <!-- A-Frame + MindAR -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  </head>

  <body>
    <a-scene
      mindar-image="imageTargetSrc: target.mind"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights, alpha:true"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: true"
      embedded
    >
      <a-assets>
        <!-- 🎥 彩色影片 (黑底) -->
        <video
          id="videoColor"
          src="myVideo_color.mp4"
          autoplay
          loop
          muted
          playsinline
          crossorigin="anonymous"
        ></video>

        <!-- 🎥 遮罩影片 (白=顯示, 黑=透明) -->
        <video
          id="videoMask"
          src="myVideo_mask.mp4"
          autoplay
          loop
          muted
          playsinline
          crossorigin="anonymous"
        ></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- 🎯 掛載目標 -->
      <a-entity mindar-image-target="targetIndex: 0" rotation="-90 0 0" position="0 0 0.5">
        <a-plane
          id="videoPlane"
          width="1"
          height="1"
          scale="1 1 1"
          material="shader: video-mask-shader; visible: false"
        ></a-plane>
      </a-entity>
    </a-scene>

    <!-- 🧩 自訂 Shader -->
    <script>
      AFRAME.registerShader("video-mask-shader", {
        schema: {},
        init: function () {
          const videoColor = document.querySelector("#videoColor");
          const videoMask = document.querySelector("#videoMask");

          const texColor = new THREE.VideoTexture(videoColor);
          texColor.minFilter = THREE.LinearFilter;
          texColor.magFilter = THREE.LinearFilter;
          texColor.format = THREE.RGBAFormat;
          texColor.encoding = THREE.sRGBEncoding;

          const texMask = new THREE.VideoTexture(videoMask);
          texMask.minFilter = THREE.LinearFilter;
          texMask.magFilter = THREE.LinearFilter;
          texMask.format = THREE.LuminanceFormat;
          texMask.encoding = THREE.sRGBEncoding;

          this.material = new THREE.ShaderMaterial({
            uniforms: {
              map: { value: texColor },
              maskMap: { value: texMask },
            },
            vertexShader: `
              varying vec2 vUV;
              void main() {
                vUV = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
              }
            `,
            fragmentShader: `
              uniform sampler2D map;
              uniform sampler2D maskMap;
              varying vec2 vUV;
              void main() {
                vec4 color = texture2D(map, vUV);
                float mask = texture2D(maskMap, vUV).r;
                mask = smoothstep(0.03, 0.98, mask);
                if(mask < 0.01){
                  discard;
                }
                gl_FragColor = vec4(color.rgb, mask);
              }
            `,
            transparent: true,
          });
        },
      });

      // ✅ 預載影片 + iOS 友好同步
      document.addEventListener("DOMContentLoaded", () => {
        const videoColor = document.querySelector("#videoColor");
        const videoMask = document.querySelector("#videoMask");
        const plane = document.querySelector("#videoPlane");

        // 預載影片
        function preloadVideos(videos, callback) {
          let loaded = 0;
          videos.forEach(video => {
            video.addEventListener('canplaythrough', () => {
              loaded++;
              if (loaded === videos.length) callback();
            }, { once: true });
            video.load();
          });
        }

        function startPlayback() {
          // 對齊遮罩時間
          videoMask.currentTime = videoColor.currentTime;
          videoColor.play().catch(() => {});
          videoMask.play().catch(() => {});

          // 顯示 plane
          plane.setAttribute("visible", true);

          // 溫和同步迴圈
          function syncLoop() {
            if (!videoColor.paused && !videoMask.paused) {
              const diff = Math.abs(videoColor.currentTime - videoMask.currentTime);
              if (diff > 0.02) videoMask.currentTime = videoColor.currentTime;
            }
            requestAnimationFrame(syncLoop);
          }
          syncLoop();
        }

        function requestIOSPermission(callback) {
          if (AFRAME.utils.device.isIOS() && DeviceMotionEvent?.requestPermission) {
            DeviceMotionEvent.requestPermission().then(() => callback()).catch(() => callback());
          } else {
            callback();
          }
        }

        requestIOSPermission(() => {
          preloadVideos([videoColor, videoMask], startPlayback);
        });

        // 點擊觸發
        document.body.addEventListener("click", () => {
          videoMask.currentTime = videoColor.currentTime;
          videoColor.play().catch(() => {});
          videoMask.play().catch(() => {});
        }, { once: true });
      });
    </script>
  </body>
</html>
